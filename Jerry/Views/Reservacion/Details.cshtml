@using Jerry.Models
@using Jerry.Models
@using Jerry.GeneralTools
@model Jerry.Models.Reservacion
@{
    ViewBag.Title = String.Format("Cliente: {0}, Res: {1}",Model.cliente.nombreCompleto, Model.ToString());
    Layout = "~/Views/Shared/_Layout.cshtml";

    //Servicios contratados dentro de la reservacion
    List<Servicio> serviciosContratados = Model.serviciosContratados != null && Model.serviciosContratados.Count() > 0
        ? Model.serviciosContratados.Select(sc => sc.servicio).ToList() : new List<Servicio>();

    Correo correo = new Correo();
    Pago p = new Pago();
    p.reservacionID = Model.reservacionID;
    correo.To = Model.cliente.email;
    ViewDataDictionary vdd = new ViewDataDictionary();
    if (ViewBag.errorPagoMsg != null)
    {
        vdd.Add("errorMsg", ViewBag.errorPagoMsg);
    }
    vdd.Add("faltante", Model.cantidadFaltante);

    Correo.ErrorEmail errorMail = ViewBag.errorMail;

    VMConfirmModalAttributes vmModalOptsEnviarCorreo = new VMConfirmModalAttributes
    {
        modalTitle = "Confirmar Envío de Estado de Cuenta",
        callType = VMConfirmModalAttributes.CallType.POSTBACK,
        action = "EnviarCorreo",
        controller = "Correo",
        routeVals = new { reservacionID = Model.reservacionID, emailDestino = Model.cliente.email },
        primaryMessage = "Si confirma, se enviará el estado de cuenta actual al cliente <strong>" + Model.cliente.nombreCompleto + "</strong>."
        + "al correo electronico <strong>" + Model.cliente.email+ "</strong>",
        modalID = "modalConfirmEnvioCorreo",
        modalStyle = new VMConfirmModalAttributes.Style(VMConfirmModalAttributes.Style.StyleTypes.INFO)
    };

    VMConfirmModalAttributes vmModalOptsRespuestaCorreo = new VMConfirmModalAttributes
    {
        callType = VMConfirmModalAttributes.CallType.NONE,
        modalID = "modalConfirmRespuestaCorreo",
    };

    if(errorMail.code == Correo.ErrorEmail.ErrorEmailCode.FAIL)
    {
        vmModalOptsRespuestaCorreo.primaryMessage = "Ocurrió un error al intentar enviar al cliente "+
            "<strong>" +Model.cliente.nombreCompleto + "</strong> su estado de cuenta al correo electronico <strong>"+Model.cliente.email+"</strong>. "+
            "Puede intentar enviar el archivo manualmente o revisar sus datos de correo electronico de administrador "+
            "en la seccion de configuracion."+
            "Contacte al administador del sistema y hagale saber el siguiente mensaje: <strong>"+errorMail.msg+"</strong>";
        vmModalOptsRespuestaCorreo.modalTitle = "Error al Enviar Estado de Cuenta";
        vmModalOptsRespuestaCorreo.modalStyle = new VMConfirmModalAttributes.Style(VMConfirmModalAttributes.Style.StyleTypes.DANGER);
    }
    else if(errorMail.code == Correo.ErrorEmail.ErrorEmailCode.SENT)
    {
        vmModalOptsRespuestaCorreo.modalTitle = "Estado de Cuenta Enviado";
        vmModalOptsRespuestaCorreo.primaryMessage = "El estado de cuenta fue enviado satisfactoriamente al cliente "+
            "<strong>"+ Model.cliente.nombreCompleto + "</strong> al correo electronico <strong>" + Model.cliente.email+ "</strong>";
        vmModalOptsRespuestaCorreo.modalStyle = new VMConfirmModalAttributes.Style(VMConfirmModalAttributes.Style.StyleTypes.SUCCESS);
    }
}

<nav class="hidden-print">
    <a class="hidden-print" href="@Url.Action("Details", "Clientes", new { id = Model.clienteID })">
        <i class="glyphicon glyphicon-arrow-left"></i> Historial de Reservaciones del Cliente
    </a> | 
    <a href="#" onClick="window.print()">
        <i class="fa fa-print"></i>
        <span>Imprimir Detalles</span>
    </a> | 
    <a data-toggle="modal" data-target="#@vmModalOptsEnviarCorreo.modalID">
        <i class="fa fa-envelope-o"></i> <span>Enviar Estado de Cuenta</span>
    </a>
</nav>

@Html.Partial("Partial_ConfirmationModal", vmModalOptsEnviarCorreo)
@Html.Partial("Partial_ConfirmationModal", vmModalOptsRespuestaCorreo)

@Html.Partial("Partial_EncabezadoReporte")

@*Detalles generales de la reservación*@
@Html.Partial("Partial_DetailsReservacion")

@*Lista de sesiones dentro de la reservación*@
@Html.Partial("Partial_ListSesiones", Model.sesiones)

<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">Servicios Contratados</h3>
    </div>
    <div class="panel-body">
        @{ 
            ViewDataDictionary vddServicios = new ViewDataDictionary();
            vddServicios.Add("showOptions", false);
        }
        @Html.Partial("../Servicios/Partial_ListServicios", serviciosContratados, vddServicios)
    </div>
</div>

@if (Model.cantidadFaltante == 0)
{
    <div class="alert alert-success">Esta reservación no presenta adeudos</div>
}
else
{
    <div class="panel panel-primary">
        <div class="panel-heading">
            <span class="panel-title">
                Historial de Pagos
            </span>
        </div>
        <div class="panel-body">
            @*Formulario de nuevo pago*@
            <div class="hidden-print">
                @Html.Partial("../Pago/Partial_IngresarPago", p, vdd)
            </div>

            @*Lista de pagos*@
            @Html.Partial("../Pago/Partial_DetallesDePagos")
            
            <div class="hidden-print">
                @using (@Html.BeginForm("EnviarCorreo", "Correo", FormMethod.Post,
                    new { @id = "form1", @enctype = "multipart/form-data" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("To", correo.To)
                    <table>
                        <tr>
                            <td>Adjuntar estado de cuenta</td>
                            <td><input type="file" name="fileUploader" /></td>
                        </tr>
                    </table>
                    <input type="submit" value="Enviar Correo" />
                }
            </div>
        </div>
    </div>
}

@section Scripts{
    <script>
        var showRespuestaModal = boolParse('@(errorMail.code!=Correo.ErrorEmail.ErrorEmailCode.NONE)');
        if (showRespuestaModal)
            $('#@(vmModalOptsRespuestaCorreo.modalID)').modal();
    </script>
}

<style>
    @@media print{
        body *{
          -webkit-print-color-adjust: exact;
        }
    }
</style>
